<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style type="text/css">
    :root {
      /* Colors */
      --color-grey-50: #fafafa;
      --color-grey-500: #9e9e9e;
      --color-grey-800: #424242;
      --color-grey-900: #212121;
      --color-bluegrey-900: #263238;
      --color-background: var(--color-grey-900);
      --color-foreground: var(--color-grey-50);

      /* Spacing */
      --spacing-half: 4px;
      --spacing-1: 8px;
      --spacing-2: 16px;
      --spacing-3: 24px;
      --spacing-4: 32px;

      /* Font Size */
      --fs-small: 0.8em;
      --fs-medium: 1em;
    }

    .m-t-4 {
      margin-top: var(--spacing-4);
    }

    .d-n-i {
      display: none !important;
    }

    html {
      height: 100%;
    }

    body {
      min-height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-family: Verdana, sans-serif;
      color: var(--color-foreground);
      background: var(--color-background);
    }

    h1,
    h2,
    h3 {
      font-family: Helvetica, sans-serif;
    }

    .text--small {
      font-size: var(--fs-small);
    }

    .form-field {
      margin: var(--spacing-1) 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .form-field label {
      font-size: var(--fs-small);
    }

    #content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex-grow: 1;
    }

    #canvas {
      border: 1px solid var(--color-grey-800);
      cursor: pointer;
    }

    #settings {
      flex-grow: 1;
    }

    #settings #settings-form {
      display: flex;
      align-items: flex-start;
      flex-wrap: wrap;
      justify-content: space-evenly;
    }

    #settings .settings-section {
      display: flex;
      flex-direction: column;
    }

    #settings .settings-section h3 {
      font-size: var(--fs-medium);
      margin-bottom: var(--spacing-1);
    }

    #footer {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-evenly;
      padding: var(--spacing-3);
    }

    #footer a {
      color: var(--color-grey-500);
      padding: var(--spacing-1);
    }
  </style>
  <script>
    const InputStyle = {
      centerDot: 'center-dot',
      even: 'even',
      shuffleEven: 'shuffle-even',
      random: 'random'
    }
  </script>

  <title>Elementary Cellular Automata</title>
</head>
<body>
  <section id="content">
    <canvas id="canvas" onclick="main()">
      Your browser doesn't support canvas
    </canvas>
    <div>
      <p class="text--small">Tap, click or refresh to update</p>
    </div>
    <button id="toggle-settings" onclick="toggleSettings()">Settings</button>
  </section>
  
  <section id="settings" class="d-n-i">    
    <form id="settings-form">
      <div class="settings-section">
        <h3>Automata</h3>
        <div class="form-field">
          <label for="base">Base:</label>
          <select name="base" id="settings__base">
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </div>
        <div class="form-field">
          <label for="input-cells">Input cells:</label>
          <select name="input-cells" id="settings__input-cells">
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </div>
        <div class="form-field">
          <label for="rule-id">Rule ID:</label>
          <div>
            <input type="checkbox" name="random-rule" id="settings__random-rule" />
            <label for="random-rule">Random rule</label>
          </div>
          <input type="number" name="rule-id" id="settings__rule-id" min="0" />
        </div>
      </div>
      <div class="settings-section">
        <h3>Display</h3>
        <div class="form-field">
          <label for="size">Size:</label>
          <input type="number" name="size" id="settings__size" min="1" max="2160" />
        </div>        
        <div class="form-field">
          <label for="zoom">Zoom:</label>
          <input type="number" name="zoom" id="settings__zoom" min="1" max="100" />
        </div>
      </div>
      <div class="settings-section">
        <h3>Other</h3>
        <div class="form-field">
          <label for="input-style">Input style:</label>
          <select name="input-style" id="settings__input-style">
          </select>
        </div>
      </div>
    </form>
  </section>
  
  <section id="footer" class="m-t-4">
    <a class="text--small" href="https://en.wikipedia.org/wiki/Elementary_cellular_automaton">
      WTF am I looking at?
    </a>
    <a class="text--small" href="https://github.com/ruslan-sh/cellular-automata">GitHub</a>
  </section>
  
  <script>
    function shuffle(array) {
      var m = array.length, t, i;
      // While there remain elements to shuffle…
      while (m) {
        // Pick a remaining element…
        i = Math.floor(Math.random() * m--);

        // And swap it with the current element.
        t = array[m];
        array[m] = array[i];
        array[i] = t;
      }

      return array;
    }

    class Automata {
      constructor(conf) {
        if (conf.base < 2 || 8 < conf.base) {
          throw 'Invalid Input';
        }
        const rulesCount = Math.pow(conf.base, conf.inputCells);
        if (Math.pow(conf.base, rulesCount) < conf.ruleId) {
          throw 'Invalid Input';
        }
        const rulesArray = new Array(rulesCount);
        let convert = conf.ruleId;
        for (let i = 0; i < rulesCount; i++) {
          rulesArray[i] = convert % conf.base;
          convert = parseInt(convert / conf.base);
        }

        this.base = conf.base;
        this.inputCells = conf.inputCells;
        this.rules = rulesArray;
      }

      invoke(input) {
        const size = input.length;
        const output = new Array(size);
        for (let i = 0; i < size; i++) {
          let ruleId = 0;
          for (let j = 0; j < this.inputCells; j++) {
            let inputIndex = i + j - parseInt(this.inputCells/2);
            if (inputIndex < 0) {
              inputIndex = size + inputIndex;
            }
            if (size <= inputIndex) {
              inputIndex = inputIndex - size;
            }
            ruleId = ruleId * this.base + input[inputIndex];
          }
          output[i] = this.rules[ruleId];
        }
        return output;
      }

      getInputRow(inputType, size) {
        size = parseInt(size);

        const centerDot = () => {
          const result = new Array(size).fill(0);
          result[parseInt(size/2)] = 1;
          return result;
        }

        const even = () => {
          let result = [];
          let baseLeft = this.base;
          let sizeLeft = size;
          while (0 < baseLeft) {
            const tmpSize = parseInt(sizeLeft/baseLeft);            
            baseLeft--;
            result = result.concat(new Array(tmpSize).fill(baseLeft));
            sizeLeft -= tmpSize;
          }
          return result;
        }

        const shuffleEven = () => {        
          return shuffle(even());
        }

        const random = () => {
          const result = new Array(size).fill(0);
          for (let i = 0; i < size; i++) {
            result[i] = Math.floor(Math.random() * this.base); 
          }
          return result;
        }

        switch (inputType) {
          case InputStyle.centerDot:
            return centerDot();
          case InputStyle.even:
            return even();
          case InputStyle.shuffleEven:
            return shuffleEven();
          default:
            return random();
        }
      }

      static getRandomRule(conf) {
        return Math.floor(Math.random() * Automata.getRulesCount(conf));
      }

      static getRulesCount(conf) {
        return Math.pow(conf.base, Math.pow(conf.base, conf.inputCells));
      }
    }

    class Display {
      constructor(conf) {
        this.size = conf.size;
        this.zoom = conf.zoom;
        this.colors = conf.colors;

        const canvas = document.getElementById('canvas');
        canvas.height = this.size * this.zoom;
        canvas.width = this.size * this.zoom;
        this.context = canvas.getContext('2d');
      }

      drawRow(rowIndex, row) {
        const y = rowIndex * this.zoom;
        for (let i = 0; i < row.length; i++) {
          const x = i * this.zoom;
          this.context.fillStyle = this.colors[row[i]];
          this.context.fillRect(x, y, this.zoom, this.zoom);
        }
      }

      static getRandomColors() {
        const colors = [
          '#FAFAFA', // black
          '#212121', // white
          '#F44336', // red
          '#4CAF50', // green
          '#2196F3', // blue
          '#FFEB3B', // yellow
          '#9C27B0', // purple
          '#00BCD4', // cyan
          ];
        return shuffle(colors);
      }
    }

    let app = {};

    function init() {
      const settingsForm = document.getElementById('settings-form');

      const changeField = (obj, field, value) => {
        if (obj[field] === value) {
          return false;
        }
        
        obj[field] = value;
        return true;
      };

      const changeForm = (form, element, value, select, set) => {
        if (!select) {
          select = (element) => {element.value;}
        }

        if (!set) {
          set = (element, value) => {element.value = value;}
        }

        const elementValue = select(form.elements[element]);
        if (elementValue === value) {
          return false;
        }

        set(form.elements[element], value);
      }

      
      app = {
        automataConf: {
          setInputCells: (value) => {
            if (changeField(app.automataConf, 'inputCells', value)) {
              changeForm(
                settingsForm,
                'rule-id', 
                Automata.getRulesCount(app.automataConf), 
                (element) => element.getAttribute("max"), 
                (element, value) => element.setAttribute("max", value));
            }

            changeForm(settingsForm, 'input-cells', value);
          },
          
          setBase: (value) => {
            if (changeField(app.automataConf, 'base', value)) {
              changeForm(
                settingsForm,
                'rule-id', 
                Automata.getRulesCount(app.automataConf), 
                (element) => element.getAttribute("max"), 
                (element, value) => element.setAttribute("max", value));
              app.setRandomRule(true);
            }

            changeForm(settingsForm, 'base', value);
          },
          
          setRuleId: (value) => {
            changeField(app.automataConf, 'ruleId', value);
            changeForm(settingsForm, 'rule-id', value);
          }
        },

        displayConf: {
          setSize: (value) => {
            changeField(app.displayConf, 'size', value);
            changeForm(settingsForm, 'size', value);
          },
          setZoom: (value) => {
            changeField(app.displayConf, 'zoom', value);
            changeForm(settingsForm, 'zoom', value);
          },
          colors: Display.getRandomColors(),
        },

        setRandomRule: (value) => {
          changeField(app, 'randomRule', value);
          changeForm(
            settingsForm,
            'random-rule',
            value,
            (element) => element.checked,
            (element, value) => element.checked = value);
          changeForm(
            settingsForm, 
            'rule-id', 
            value,
            (element) => element.disabled,
            (element, value) => element.disabled = value);        
        },

        setInputStyle: (value) => {
          console.log(value);
          changeField(app, 'inputStyle', value);
          changeForm(settingsForm, 'input-style', value);
        }
      };

      // Init select
      const inputStyleSelect = settingsForm.elements['input-style'];
      Object.entries(InputStyle).forEach(([_, value]) => {
        const option = document.createElement('option');
        option.value = value;
        option.innerHTML = value;
        inputStyleSelect.appendChild(option);
      })

      // Default config
      app.automataConf.setBase(3);
      app.automataConf.setInputCells(3);
      app.displayConf.setSize(360);
      app.displayConf.setZoom(2);
      app.setRandomRule(true);
      app.setInputStyle(InputStyle.shuffleEven);

      settingsForm.addEventListener('change', () => {
        app.automataConf.setBase(settingsForm.elements['base'].value);
        app.automataConf.setInputCells(settingsForm.elements['input-cells'].value);
        app.automataConf.setRuleId(settingsForm.elements['rule-id'].value);

        app.displayConf.setSize(settingsForm.elements['size'].value);
        app.displayConf.setZoom(settingsForm.elements['zoom'].value);

        app.setRandomRule(settingsForm.elements['random-rule'].checked);
        app.setInputStyle(settingsForm.elements['input-style'].value);
      });
    }

    function main() {
      if (app.randomRule) {
        app.automataConf.setRuleId(Automata.getRandomRule(app.automataConf));
      }
      app.displayConf.colors = Display.getRandomColors();
      const automata = new Automata(app.automataConf);      
      const display = new Display(app.displayConf);      
      let row = automata.getInputRow(app.inputStyle, app.displayConf.size);
      display.drawRow(0, row);
      for (let i = 1; i < app.displayConf.size; i++) {
        row = automata.invoke(row);
        display.drawRow(i, row);
      }
    }

    /* exported toggleSettings */
    function toggleSettings() {
      const settingsSection = document.getElementById("settings");
      settingsSection.classList.toggle('d-n-i');
    }
    
    init();
    main();
  </script>
</body>
</html>
